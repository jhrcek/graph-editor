<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Elm Graph Editor</title>
  <!-- Bootstrap v4.1.3 -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <!-- Viz.js v2.1.2 -->
  <script src="js/viz.js"></script>
  <script src="js/full.render.js"></script>
  <script src="js/app.js"></script>
</head>

<body>
  <div id="elm"></div>
  <script>
    var app = Elm.Main.init({
      node: document.getElementById('elm')
    });

    /* Port for determining Bounding Box of SVG element with given ID
     * BBox is used to determine exact size of rectangle drawn around the text
     */
    app.ports.requestBoundingBox.subscribe(function(idOfSvgText) {
      requestAnimationFrame(function() {
        var text = document.getElementById(idOfSvgText);
        var bbox = text.getBBox();
        bbox.elementId = idOfSvgText;
        app.ports.setBoundingBox.send(bbox);
      })
    });

    /* Port for initiating download of graph export file */
    app.ports.download.subscribe(function(msg) {
      /* taken from https://stackoverflow.com/a/33542499/403702 */
      var blob = new Blob([msg.data], {
        type: 'text/plain'
      });
      if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveBlob(blob, msg.filename);
      } else {
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = msg.filename;
        document.body.appendChild(elem);
        elem.click();
        document.body.removeChild(elem);
      }
    });

    /* Port for calling external graphviz library (viz.js). Given graphviz source
     * String (without layout info) it will generate output in graphviz "plain" format,
     * enriched by layout information (x,y) of individual nodes.
     */
    app.ports.requestGraphVizPlain_Impl.subscribe(function(request) {
      var viz = new Viz();
      var renderOptions = {
        engine: request.layoutEngine,
        format: "plain",
        yInvert: false,
        images: [],
        files: []
      };
      viz.renderString(request.graphvizSource, renderOptions)
        .then(function(plainOutput) {
          app.ports.receiveGraphVizPlain.send({
            GraphViz_PlainOutput: plainOutput
          });
        })
        .catch(error => {
          app.ports.receiveGraphVizPlain.send({
            GraphViz_Error: error.message
          });
        });
    });
  </script>
</body>

</html>
